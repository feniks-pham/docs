name: Sync Documentation to VNG Cloud Storage

on:
  push:
    branches: [main]
    paths:
      - 'vn/**'
  workflow_dispatch:

jobs:
  sync-to-s3:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Install AWS CLI
        run: |
          pip install awscli
        
      - name: Configure AWS CLI
        run: |
          mkdir -p ~/.aws
          echo "[default]" > ~/.aws/credentials
          echo "aws_access_key_id = ${{ secrets.S3_ACCESS_KEY_ID }}" >> ~/.aws/credentials
          echo "aws_secret_access_key = ${{ secrets.S3_SECRET_ACCESS_KEY }}" >> ~/.aws/credentials
          echo "region = ${{ secrets.S3_REGION || 'ap-southeast-1' }}" >> ~/.aws/credentials
          
      - name: Sync vn folder to VNG Cloud Storage
        run: |
          aws s3 sync ./vn s3://test-git-action/ --delete --endpoint-url ${{ secrets.S3_ENDPOINT_URL }}
          
      - name: Call sync KB API
        run: |
          curl -X POST http://103.196.239.132:8000/kb/sync-kb \
            -H "Content-Type: application/json" 
